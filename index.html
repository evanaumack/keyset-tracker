<html>
    <head>
        <title>Keyset Tracker</title>
        <meta charset='utf-8'>
        <script type="text/javascript" src="js/ICanHaz.js"></script>
        <script type="text/javascript" src='js/jquery.js '></script>
        <script type="text/javascript" src='js/tabletop1.3.4.js'></script>
        <script type="text/javascript" src='js/sheetsee.js'></script>
        <script type="text/javascript" src='js/leaflet.markercluster.js'></script>
        <link rel="shortcut icon" href="favico.png"/>
        

        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <link href='http://api.tiles.mapbox.com/mapbox.js/v1.4.0/mapbox.css' rel='stylesheet' />
        <link rel='stylesheet' type='text/css' href='http://fonts.googleapis.com/css?family=Lato:300,400,700,300italic'>
        <link rel='stylesheet' type='text/css' href='http://fonts.googleapis.com/css?family=Amatic+SC:400,700'>
        <link rel='stylesheet' type='text/css' href='http://fonts.googleapis.com/css?family=Oswald:300,400,700'>
        <link rel='stylesheet' type='text/css' href='http://fonts.googleapis.com/css?family=Archivo+Narrow:300,400italic'>
        <link media="screen" rel="stylesheet" type="text/css" href="css/style.css">
        <link media="screen" rel="stylesheet" type="text/css" href="css/site.css">
        <link rel="stylesheet" href="css/MarkerCluster.css" />
        <link rel="stylesheet" href="css/MarkerCluster.Default.css" />

        <link rel="stylesheet" id="font-awesome-css" href="css/font-awesome.css" type="text/css" media="screen">

        <style>
            .scroll-top-wrapper {
                position: fixed;
                opacity: 0;
                visibility: hidden;
                overflow: hidden;
                text-align: center;
                z-index: 99999999;
                background-color: #777777;
                color: #eeeeee;
                width: 50px;
                height: 48px;
                line-height: 48px;
                right: 30px;
                bottom: 30px;
                padding-top: 2px;
                border-top-left-radius: 10px;
                border-top-right-radius: 10px;
                border-bottom-right-radius: 10px;
                border-bottom-left-radius: 10px;
                -webkit-transition: all 0.5s ease-in-out;
                -moz-transition: all 0.5s ease-in-out;
                -ms-transition: all 0.5s ease-in-out;
                -o-transition: all 0.5s ease-in-out;
                transition: all 0.5s ease-in-out;
            }
            .scroll-top-wrapper:hover {
                background-color: #888888;
            }
            .scroll-top-wrapper.show {
                visibility:visible;
                cursor:pointer;
                opacity: 1.0;
            }
            .scroll-top-wrapper i.fa {
                line-height: inherit;
            }
 
        </style>

        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-45437402-2', 'auto');
            ga('send', 'pageview');

        </script>
    </head>

    <style>
        .photo {display: inline-block; float: left; width: 100px;}
        #photogrid {overflow: auto;}

        .tooltipImageContainer {
            position: relative;
            width: 0px;
            height: 0px;
            top: -260px; /* this must be absolutely (math definition) equal or greater than the tooltip backdrop height (after it resizes to hold the image) */  
        }

        .tooltipImageBackdrop {
            display: inline-block;
            padding: 30px;
            background-color: lightgray;
        }

        .tooltipImageContainer img:first-child {
            width: auto;
            height: 180px;
        }
    </style>

<body>
    <div id="wrapper">
        <h1>Keyset Tracker</h1>
        <div>
            <ul class="nav">
                <li><strong>A collection of keyset group buys</strong></li>
                <li><a href="#info">INFO</a> -</li>
                <li>POWERED BY SHEETSEE.JS -</li>
                
                <li><a href="http://www.twitter.com/KeysetTracker" target="_blank">@KeysetTracker</a></li>
            </ul>
        </div>
        <div class="container">
           
                <div id="latestSpot"></div>
                <div id="selectedSpot"></div>
          
         
            <div id="map"></div>

        </div>
        
        <div class="container">
            <input id="tableFilter" type="text" placeholder="filter by.."></input>
            <span class="clear button">Clear</span> 
            <span class="noMatches">no matches</span>
            <div id="hackSpotsTable"></div>
        </div>
        
        <div id="info" class="container">
            <h3>Contribute!</h3>
            <div id="theNumberofSpots"></div>
            <p>Want to contribute? Shoot over a message! See something wrong? Make sure to make it known! <a href="https://docs.google.com/forms/d/17w-uonznjoZ7V7lNpAzG9zr7aNbPuCDM1Tv1yu-PFew/" target="_blank">Here's a form link.</a> Fill it out if you think we're missing a keyset or want to add your own. You will also be able to ask questions and get in contact with us through the form. </p>

            <h3>Subscribe</h3>
            <p>Want updates? You can fill out <a href="https://docs.google.com/forms/d/1rBLKvLqZKt7UKIvThngi0B-GFv-xAgfXODLtjZ3llv8" target="_blank">the form at this link</a> and we'll set you up with some emails. Due to the automated nature of the list, we can't use a traditional subscription service. You won't receive a confirmation email but you'll be put on the lists you select. If you realize you haven't been receiving emails, get in touch with us at <a href="mailto:keyset.me@gmail.com" target"_blank">keyset.me@gmail.com</a> and we'll check it out. If you wish to unsubscribe from the email lists, there will be a link inside each email that will allow you to fill out an unsubscribe form.
                
            <h3>Info</h3>

            <p>This site started as a method to keep track of keysets internally without the need to remember to visit a bunch of pages. It evolved into a full fledged tracker after the sudden influx of group buys over the past month. It was hashed out in a few days so it's pretty rough around the edges. The tracker will be updated frequently as group buys come and go. Only 'current' group buys will be on the tracker. Once an item has mostly been recieved by buyers, it will be removed.</p>
        </div>
        <div class="scroll-top-wrapper ">
            <span class="scroll-top-inner">
                <i class="fa fa-2x fa-arrow-circle-up"></i>
                </span>
        </div>
    </div><!-- end wrapper -->

<script id="photogrid" type="text/html">
  {{#rows}}
    <div class=""><a href="{{imgurl}}" target="_blank"><img class="photo" src="{{imgurl}}"  alt="name"></a></div>
  {{/rows}}
</script>

    <script id="hackSpotsTable" type="text/html">
        <table>
            <tr><th class="tHeader">Name</th><th class="tHeader">Vendor</th><th class="tHeader">Creator</th><th class="tHeader">Profile</th><th class="tHeader">Status</th><th class="">Visit</th></tr>
            {{#rows}}
                <tr id="{{rowNumber}}" class="spotRow"><td>{{name}}</td><td>{{vendor}}</td><td>{{creator}}</td><td>{{outlets}}</td><td>{{status}}</td><td><a class="button" href="{{located}}" target="_blank">GB Page <i class="fa fa-external-link"></i></a> </td></tr>
            {{/rows}}
        </table>
    </script>

    <script id="latestSpot" type="text/html">
        {{#rows}}
            <h4 class="fauxButton">MOST RECENT BUY</h4>
            <h2>{{name}}</h2>
            
            <ul>
                <li><img src="{{imgurl}}" target="_blank"/></li>
                <li><span class="category"></span> </li>
                <li><span class="categorystatus">Status:</span><span class="categorycolor">{{status}}</span></li>
                <li><span class="category">Profile:</span> {{profile}}</li>
                <li><span class="category">Plastic:</span> {{plastic}}</li>
                <li><span class="category">Child Deals:</span> {{couch}}</li>
                <li><span class="category">Starting Price:</span> {{largetable}}</li>
                <li><span class="category">Ending Date:</span> {{endingdate}}</li>
                <li><span class="category">Created By:</span> {{creator}}</li>
                
            </ul>
            <ul>
               
                <li><span style="font-size: 13px;"><a href="{{located}}" target="_blank">Check out the buy</a></span></li>
            </ul>
        {{/rows}}
    </script>



    <script id="theNumberofSpots" type="text/html">
        <p><strong><span class="red-text">{{numberOfSpots}}</span> keysets running!</p>
    </script>

    <script id="selectedSpot" type="text/html">
        {{#rows}}
            <h4 class="fauxButton">SELECTED BUY</h4>
            <h2>{{name}}</h2>
            
            <ul>
               <li><img src="{{imgurl}}" target="_blank"/></li>
                <li><span class="category"></span> </li>
                <li><span class="categorystatus">Status:</span><span class="categorycolor">{{status}}</span></li>
                <li><span class="category">Profile:</span> {{profile}}</li>
                <li><span class="category">Plastic:</span> {{plastic}}</li>
                <li><span class="category">Child Deals:</span> {{couch}}</li>
                <li><span class="category">Starting Price:</span> {{largetable}}</li>
                <li><span class="category">Ending Date:</span> {{endingdate}}</li>
                <li><span class="category">Created By:</span> {{creator}}</li>
           
            </ul>
            <ul>
                <li><span style="font-size: 13px;"><a href="{{located}}" target="_blank">Check out the buy</a></span></li>
            </ul>
        {{/rows}}
    </script>

    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', function() {
            var gData
            //var URL = "1hnfQcggYcBYimuO_UOMvwoOi_I9vUvFpkMt4wjrrpLE"
            var URL = "1_-U4icgfEFtqyL2ie7z0J27vtNeVuCJw3eDzB6FqnY4"
                Tabletop.init({ key: URL, callback: showInfo, simpleSheet: true })
        })

        // so long, so messy
        function showInfo(gData) {
            tableOptions = {
                "data": gData,
                "tableDiv": "#hackSpotsTable",
                "filterDiv": "#tableFilter"
            }
            // make the table, and the search bar
            Sheetsee.makeTable(tableOptions)
            Sheetsee.initiateTableFilter(tableOptions)

            // create geoJSON with coordinates and other
            // useful bits from the original data
            var optionsJSON = ["name", "vendor", "creator", "rowNumber"]
            var geoJSON = Sheetsee.createGeoJSON(gData, optionsJSON)

            // create map, tilelayer (map background), markers and popups
            var map = Sheetsee.loadMap("map")
            Sheetsee.addTileLayer(map, 'examples.map-20v6611k')
            var markerLayer = Sheetsee.addMarkerLayer(geoJSON, map, "<h2>{{ name }}</h2>")

            // find the latest spot with the most important
            // info filled in (to prevent map breaking if
            // someone is currently editing spreadsheet)
            var theLatestSpot = findLatestCompleteSpot(gData)
            var latestSpot = Sheetsee.ich.latestSpot({
                rows: theLatestSpot
            })
            // set it and pan to it
            $('#latestSpot').html(latestSpot)
            map.setView([theLatestSpot.lat, theLatestSpot.long], 14)


            $('#hackSpotsTable').on('hover', '.spotRow', function(event) {
                var targetRow = $(this).closest("tr")
                var rowNumber = targetRow.attr("id")
                
                var dataElement = Sheetsee.getMatches(gData, rowNumber, "rowNumber")
                var selectedSpot = Sheetsee.ich.selectedSpot({
                    rows: dataElement
                })

                $(".tooltipImageContainer").remove()

                var tooltip = $("<div class='tooltipImageContainer'>").html(selectedSpot)
                var tooltipImage = tooltip.find("img:first").clone()
                var tooltipImageBackdrop = $("<div class='tooltipImageBackdrop' />")

                tooltipImageBackdrop.append(tooltipImage);
                tooltip.empty().append(tooltipImageBackdrop)

                targetRow.find("td:first").append(tooltip)
            })

            $('#hackSpotsTable').on('hover', '.tooltipImageContainer', function() {
                $(".tooltipImageContainer").remove()
            })

            $('#hackSpotsTable').mouseleave(function() {
                $(".tooltipImageContainer").remove()
            })

            // when someone clicks on a row, highlight it and
            // re-center the map
            // TODO show popup, change marker color
            $('.spotRow').live("click", function(event) {
                $('.spotRow').removeClass("selectedRow")
                var rowNumber = $(this).closest("tr").attr("id")
                $('#' + rowNumber).addClass("selectedRow")
                var dataElement = Sheetsee.getMatches(gData, rowNumber, "rowNumber")
                var selectedSpot = Sheetsee.ich.selectedSpot({
                    rows: dataElement
                })
                $('#latestSpot').css("display", "none")
                $('#selectedSpot').html(selectedSpot).css("display", "inline")
            })

            // so that the first map and info that loads
            // is complete and doesn't show rows that are
            // actively being edited by folk
            function findLatestCompleteSpot(data) {
                var latestCompleteSpot = []
                var startWithLatestRow = data.reverse()
                startWithLatestRow.forEach(function(row){
                    if (!row.lat || !row.long || !row.name || !row.vendor || !row.creator || !row.profile ) return
                    else latestCompleteSpot.push(row)
                })
                return latestCompleteSpot[0]
            }

            // Add click listener to the markerLayer
            markerLayer.on('click', function(e) {
                // clear any selected rows
                $('.spotRow').removeClass("selectedRow")
                // get row number of selected marker
                var rowNumber = e.layer.feature.opts.rowNumber
                // find that row in the table and make consider it selected
                $('#' + rowNumber).addClass("selectedRow")
                // using row number, get the data for the selected spot
                var dataElement = Sheetsee.getMatches(gData, rowNumber.toString(), "rowNumber")
                // take those details and re-write the selected spot section
                var selectedSpot = Sheetsee.ich.selectedSpot({
                    rows: dataElement
                })
                // center the map on the selected element
                map.panTo([dataElement[0].lat, dataElement[0].long])
                // update the spot listing
                $('#latestSpot').css("display", "none")
                $('#selectedSpot').html(selectedSpot).css("display", "inline")
            })

            // reset the map, zoom out, and recenter on 0,0
            $('.resetMap').click(function() {
                $('.spotRow').removeClass("selectedRow")
                $('#latestSpot').css("display", "inline")
                $('#selectedSpot').css("display", "none")
                map.setView([0,0], 1)
            })

            // find total number of spots added
            var theNumberofSpots = Sheetsee.ich.theNumberofSpots({
                numberOfSpots: gData.length
            })
            $('#theNumberofSpots').html(theNumberofSpots)

            if(window.location.hash) {
                $('#tableFilter').val(window.location.hash.substring(1)).keyup()
                $('.spotRow').first().click()
            }
        }

            var html = Sheetsee.ich.photogrid({'rows': data})
            $('#photogrid').html(html)

        $(document).on('keyup', '#tableFilter', function() {
            window.location.hash = $(this).val()
            $('.spotRow').first().click()
        })
    </script>

    <script>
 
        $(function(){
 
            $(document).on( 'scroll', function(){
 
                if ($(window).scrollTop() > 100) {
                    $('.scroll-top-wrapper').addClass('show');
                } else {
                    $('.scroll-top-wrapper').removeClass('show');
                }
            });
        });
    </script>


    <script>
 
        $(function(){
 
            $(document).on( 'scroll', function(){
 
                if ($(window).scrollTop() > 100) {
                    $('.scroll-top-wrapper').addClass('show');
                } else {
                    $('.scroll-top-wrapper').removeClass('show');
                }
            });
 
            $('.scroll-top-wrapper').on('click', scrollToTop);
        });
 
        function scrollToTop() {
            verticalOffset = typeof(verticalOffset) != 'undefined' ? verticalOffset : 0;
            element = $('body');
            offset = element.offset();
            offsetTop = offset.top;
            $('html, body').animate({scrollTop: offsetTop}, 500, 'linear');
        }
        </script>

</body>
</html>
